<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <title>Janus</title>
    <style>
      body {
        font-family: "Segoe UI", sans-serif;
        padding: 1.2em; /* åŸ 2em ç¼©å° */
        max-width: 960px;
        margin: auto;
        background-color: #f0f2f5;
        color: #333;
        line-height: 1.5; /* åŸ 1.6 æ›´ç´§å‡‘ */
      }

      h1,
      h2 {
        color: #2c3e50;
        margin-top: 1em; /* åŸ 1.5em ç¼©å° */
        margin-bottom: 0.5em; /* æ·»åŠ åº•éƒ¨é—´è·æ§åˆ¶ */
        font-size: 1.4em; /* åŸæ¥è¾ƒå¤§ï¼Œç•¥å¾®ç¼©å° */
      }

      table {
        border-collapse: collapse;
        width: 100%;
        margin-top: 0.8em; /* åŸ 1em */
        background: white;
        border-radius: 6px; /* åŸ 8px */
        overflow: hidden;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05); /* æ›´è½»çš„é˜´å½± */
      }

      th {
        background-color: #f3f4f6;
        font-weight: bold;
        font-size: 14px;
      }

      th,
      td {
        padding: 6px 8px; /* åŸ 8px 12px */
        border: 1px solid #ccc;
        text-align: center;
        font-size: 13.5px;
      }

      tr:hover {
        background-color: #f9f9f9;
      }

      select,
      button,
      input {
        padding: 4px 8px; /* åŸ 6px 12px */
        margin-top: 6px; /* åŸ 10px */
        margin-right: 6px;
        font-size: 0.95em;
        border: 1px solid #ccc;
        border-radius: 4px;
      }

      canvas {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }

      @media (prefers-color-scheme: dark) {
        body {
          background-color: #121212;
          color: #eee;
        }
        h1,
        h2 {
          color: #cfd8dc;
        }
        table,
        canvas {
          background: #1e1e1e;
          color: #ccc;
        }
        th {
          background-color: #2c2c2c;
        }
        tr:hover {
          background-color: #2a2a2a;
        }
        input,
        select {
          background-color: #2a2a2a;
          color: #fff;
          border-color: #444;
        }
        input[disabled] {
          background-color: #1e1e1e;
          color: #ccc;
        }
        #logContainer {
          background-color: #1e1e1e;
          color: #ccc;
          border-color: #444;
        }
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1"></script>
  </head>
  <body>
    <h1>ğŸŒ Hiï¼ç§ã®åå‰ã¯Janus!ãã†ã‚ˆã€ã‚ã®Jervisã®åƒšè‰¦ã®â€¦â€¦</h1>

    <h2>ğŸ“Š æœ€æ–°æ±‡ç‡</h2>
    <table id="rateTable">
      <thead>
        <tr>
          <th>æ—¥æœŸ</th>
          <th>è´§å¸</th>
          <th>æ±‡ç‡</th>
          <th>é¢„æµ‹æ±‡ç‡</th>
          <th>é¢„æµ‹æ—¶é—´</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <h2>ğŸ’± æ±‡ç‡æ¢ç®—</h2>
    <div
      style="
        display: flex;
        align-items: center;
        gap: 6px; /* åŸæ¥è¾ƒå¤§ï¼Œè°ƒå° */
        padding: 0.8em; /* ç¼©å°å†…è¾¹è· */
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        max-width: 750px;
        flex-wrap: wrap;
      "
    >
      <select
        id="sourceCurrency"
        style="
          width: 200px;
          height: 42px;
          font-size: 1.05em;
          padding: 6px 10px;
          border-radius: 6px;
          border: 1px solid #ccc;
        "
      ></select>

      <input
        type="number"
        id="sourceAmount"
        value="1"
        min="0"
        step="0.01"
        style="
          width: 120px;
          height: 42px;
          font-size: 1.05em;
          padding: 6px 10px;
          border-radius: 6px;
          border: 1px solid #ccc;
        "
      />

      <span style="font-size: 1.4em">â‡¨</span>

      <span
        style="
          min-width: 90px;
          height: 42px;
          line-height: 42px;
          font-size: 1.05em;
        "
        >ğŸ‡¨ğŸ‡³ äººæ°‘å¸</span
      >

      <input
        type="text"
        id="convertedCny"
        disabled
        style="
          width: 120px;
          height: 42px;
          font-size: 1.1em;
          padding: 6px 10px;
          border-radius: 6px;
          border: 1px solid #ccc;
          background-color: #f4f4f4;
          color: #333;
        "
      />
    </div>

    <p id="exchangeSummary" style="margin: 0.4em 0; font-weight: bold"></p>
    <p style="font-size: 0.9em; color: gray">
      æ›´æ–°æ—¶é—´ï¼š<span id="updatedTime">-</span>
    </p>

    <h2>ğŸ“ˆ æ±‡ç‡èµ°åŠ¿å›¾</h2>
    <select id="currencySelect" onchange="updateChart()"></select>
    <canvas
      id="rateChart"
      width="800"
      height="300"
      style="max-width: 100%; margin-top: 1em"
    ></canvas>

    <h2>ğŸ” æŸ¥çœ‹å†å²æ•°æ®</h2>
    <a href="/history" target="_blank"><button>æŸ¥çœ‹å†å²è®°å½•</button></a>

    <h2>ğŸ“„ å®æ—¶æ—¥å¿—</h2>
    <div
      id="logContainer"
      style="
        white-space: pre-wrap;
        font-family: monospace;
        background: #f7f7f7;
        border: 1px solid #ccc;
        border-radius: 6px;
        padding: 1em;
        max-height: 400px;
        overflow-y: auto;
      "
    ></div>

    <script>
      const flagMap = {
        AUD: "ğŸ‡¦ğŸ‡º",
        USD: "ğŸ‡ºğŸ‡¸",
        JPY: "ğŸ‡¯ğŸ‡µ",
        EUR: "ğŸ‡ªğŸ‡º",
        GBP: "ğŸ‡¬ğŸ‡§",
        CNY: "ğŸ‡¨ğŸ‡³",
      };
      const currencyNameMap = {
        AUD: "æ¾³å¤§åˆ©äºšå…ƒ",
        USD: "ç¾å…ƒ",
        JPY: "æ—¥å…ƒ",
        EUR: "æ¬§å…ƒ",
        GBP: "è‹±é•‘",
        CNY: "äººæ°‘å¸",
      };
      let chartInstance = null,
        allData = {},
        latestRateMap = {};

      function loadLogs() {
        fetch("/api/logs/latest")
          .then((res) => res.json())
          .then((data) => {
            const logLines = data.log.split("\n");
            const container = document.getElementById("logContainer");
            container.innerHTML = "";

            const importantLevels = ["INFO","WARNING", "ERROR", "CRITICAL"];

            logLines.forEach((line) => {
              if (
                importantLevels.some((level) => line.includes(`[${level}]`))
              ) {
                const div = document.createElement("div");
                div.textContent = line;

                // æ·»åŠ é¢œè‰²æ ‡è®°ï¼ˆå¯é€‰ï¼‰
                if (line.includes("[ERROR]")) div.style.color = "red";
                else if (line.includes("[WARNING]")) div.style.color = "orange";
                else if (line.includes("[CRITICAL]"))
                  div.style.color = "purple";

                container.appendChild(div);
              }
            });

            container.scrollTop = container.scrollHeight;
          });
      }

      function loadLatestRates() {
        fetch("/api/latest")
          .then((res) => res.json())
          .then((data) => {
            const tbody = document.querySelector("#rateTable tbody");
            latestRateMap = {};
            tbody.innerHTML = "";
            data.forEach((row) => {
              latestRateMap[row.Currency] = row.Rate;
              const tr = document.createElement("tr");
              tr.innerHTML = `
              <td>${row.Date}</td>
              <td>${flagMap[row.Currency] || ""} ${
                currencyNameMap[row.Currency] || row.Currency
              }</td>
              <td>${row.Rate}</td>
              <td>${
                row.PredictedRate !== null
                  ? row.PredictedRate.toFixed(4)
                  : "N/A"
              }</td>
              <td>${row.PredictionDate || "â€”"}</td>`;
              tbody.appendChild(tr);
            });
            setupCnyConverter(data);
          });
      }

      function setupCnyConverter(latestData) {
        const select = document.getElementById("sourceCurrency");
        const summary = document.getElementById("exchangeSummary");
        const updateTime = document.getElementById("updatedTime");

        const rates = {};
        latestData.forEach((row) => {
          if (row.Currency !== "CNY") rates[row.Currency] = row.Rate;
        });

        select.innerHTML = Object.keys(rates)
          .map(
            (cur) =>
              `<option value="${cur}">${flagMap[cur] || ""} ${
                currencyNameMap[cur] || cur
              }</option>`
          )
          .join("");

        select.value = "AUD";

        function updateDisplay() {
          const cur = select.value;
          const rate = rates[cur] / 100;
          const amount =
            parseFloat(document.getElementById("sourceAmount").value) || 0;
          const cnyValue = amount * rate;
          document.getElementById("convertedCny").value = cnyValue.toFixed(4);
          summary.innerHTML = `
          <div>1 ${currencyNameMap[cur] || cur} â‰ˆ ${rate.toFixed(
            4
          )} äººæ°‘å¸</div>
          <div>1 äººæ°‘å¸ â‰ˆ ${(1 / rate).toFixed(4)} ${
            currencyNameMap[cur] || cur
          }</div>`;
        }

        document
          .getElementById("sourceCurrency")
          .addEventListener("change", updateDisplay);
        document
          .getElementById("sourceAmount")
          .addEventListener("input", updateDisplay);

        const firstDate = latestData.find((d) => d.Date);
        if (firstDate) updateTime.textContent = firstDate.Date;
        updateDisplay();
      }

      function loadChartData() {
        fetch("/api/history/chart")
          .then((res) => res.json())
          .then((data) => {
            allData = data;
            const select = document.getElementById("currencySelect");
            select.innerHTML = Object.keys(data)
              .map(
                (k) =>
                  `<option value="${k}">${currencyNameMap[k] || k}</option>`
              )
              .join("");
            updateChart();
          });
      }

      function updateChart() {
        const currency = document.getElementById("currencySelect").value;
        const data = allData[currency] || [];
        const now = new Date();
        const windowStart = new Date(now.getTime() - 2 * 86400000);
        const filtered = data.filter(
          (d) => new Date(d.datetime) >= windowStart
        );
        const historyOnly = filtered.filter((d) => d.rate !== null);
        const predictionOnly = filtered.filter(
          (d) => d.rate === null && d.predicted !== null
        );
        const combined = [...historyOnly, ...predictionOnly];
        const labels = combined.map((d) => d.datetime);
        const historyRates = combined.map((d) =>
          d.rate !== null ? d.rate : null
        );
        const predictionRates = combined.map((d) =>
          d.rate === null && d.predicted !== null ? d.predicted : null
        );

        const lastHistIndex = historyRates
          .map((v, i) => (v !== null ? i : -1))
          .filter((i) => i !== -1)
          .pop();
        const firstPredIndex = predictionRates.findIndex((v) => v !== null);
        const connectorData = new Array(combined.length).fill(null);
        if (lastHistIndex !== undefined && firstPredIndex !== -1) {
          connectorData[lastHistIndex] = historyRates[lastHistIndex];
          connectorData[firstPredIndex] = predictionRates[firstPredIndex];
        }

        const ctx = document.getElementById("rateChart").getContext("2d");
        if (chartInstance) chartInstance.destroy();
        chartInstance = new Chart(ctx, {
          type: "line",
          data: {
            labels: labels,
            datasets: [
              {
                label: `${currencyNameMap[currency] || currency} å†å²æ±‡ç‡`,
                data: historyRates,
                borderColor: "rgba(75, 192, 192, 1)",
                backgroundColor: "rgba(75, 192, 192, 0.1)",
                fill: true,
                tension: 0.2,
              },
              {
                label: `${currencyNameMap[currency] || currency} é¢„æµ‹æ±‡ç‡`,
                data: predictionRates,
                borderColor: "rgba(255, 99, 132, 1)",
                borderDash: [6, 6],
                pointBackgroundColor: "rgba(255, 99, 132, 1)",
                pointStyle: "circle",
                pointRadius: 4,
                fill: false,
                tension: 0,
              },
              {
                label: "è¿æ¥çº¿",
                data: connectorData,
                borderColor: "rgba(128, 128, 128, 0.5)",
                borderDash: [3, 3],
                pointRadius: 0,
                fill: false,
                tension: 0,
                spanGaps: true,
              },
            ],
          },
          options: {
            responsive: true,
            interaction: { mode: "index", intersect: false },
            plugins: {
              tooltip: {
                callbacks: {
                  title: (ctx) => `æ—¶é—´ï¼š${ctx[0].label}`,
                  label: (ctx) => `${ctx.dataset.label}ï¼š${ctx.formattedValue}`,
                },
              },
              legend: {
                labels: {
                  usePointStyle: true,
                  filter: (item) => item.text !== "è¿æ¥çº¿",
                },
              },
              zoom: {
                limits: { x: { minRange: 5 } },
                zoom: {
                  wheel: { enabled: true },
                  pinch: { enabled: true },
                  mode: "x",
                },
                pan: { enabled: true, mode: "x" },
              },
            },
            scales: {
              x: {
                min: labels.length > 10 ? labels.length - 10 : 0,
                max: labels.length - 1,
                title: { display: true, text: "æ—¶é—´" },
                ticks: { display: false },
              },
              y: {
                title: { display: true, text: "æ±‡ç‡" },
                grace: "5%",
              },
            },
          },
        });
      }

      window.onload = function () {
        loadLatestRates();
        loadChartData();
        loadLogs(); // åŠ è½½æ—¥å¿—
        setInterval(loadLogs, 1000 * 60 * 10); // æ¯ 10 åˆ†é’Ÿåˆ·æ–°
      };
    </script>
  </body>
</html>
