<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <title>Janus API æœåŠ¡</title>
    <style>
      body {
        font-family: sans-serif;
        padding: 2em;
        max-width: 960px;
        margin: auto;
      }
      h1 {
        color: #2c3e50;
      }
      ul {
        line-height: 1.8em;
      }
      code {
        background: #f4f4f4;
        padding: 0.2em 0.5em;
        border-radius: 4px;
      }
      table {
        border-collapse: collapse;
        width: 100%;
        margin-top: 1em;
      }
      th,
      td {
        padding: 8px 12px;
        border: 1px solid #ccc;
        text-align: center;
      }
      select,
      button {
        padding: 6px 12px;
        margin-top: 10px;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
  </head>
  <body>
    <h1>ğŸŒ Hiï¼ç§ã®åå‰ã¯Janus!</h1>

    <h2>âš“ å¯ç”¨æ¥å£ï¼š</h2>
    <ul>
      <li><code>GET /api/history</code> - æŸ¥çœ‹å†å²è®°å½•</li>
      <li><code>GET /api/logs/latest</code> - æŸ¥çœ‹æœ€æ–°æ—¥å¿—</li>
    </ul>

    <h2>ğŸ“Š æœ€æ–°æ±‡ç‡</h2>
    <table id="rateTable">
      <thead>
        <tr>
          <th>æ—¥æœŸ</th>
          <th>è´§å¸</th>
          <th>æ±‡ç‡</th>
          <th>é¢„æµ‹æ±‡ç‡</th>
          <th>é¢„æµ‹æ—¶é—´</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <h2>ğŸ“ˆ æ±‡ç‡èµ°åŠ¿å›¾</h2>
    <select id="currencySelect" onchange="updateChart()"></select>
    <canvas
      id="rateChart"
      width="800"
      height="300"
      style="max-width: 100%; margin-top: 1em"
    ></canvas>

    <h2>ğŸ” æŸ¥çœ‹å®Œæ•´å†å²æ•°æ®</h2>
    <a href="/history" target="_blank"><button>æŸ¥çœ‹å†å²è®°å½•è¡¨</button></a>

    <script>
      let chartInstance = null;
      let allData = {};

      function loadLatestRates() {
        fetch("/api/latest")
          .then((res) => res.json())
          .then((data) => {
            const tbody = document.querySelector("#rateTable tbody");
            tbody.innerHTML = "";
            data.forEach((row) => {
              const tr = document.createElement("tr");
              tr.innerHTML = `
              <td>${row.Date}</td>
              <td>${row.Currency}</td>
              <td>${row.Rate}</td>
              <td>${
                row.PredictedRate !== null
                  ? row.PredictedRate.toFixed(4)
                  : "N/A"
              }</td>
              <td>${row.PredictionDate || "â€”"}</td>
            `;
              tbody.appendChild(tr);
            });
          });
      }

      function loadChartData() {
        fetch("/api/history/chart")
          .then((res) => res.json())
          .then((data) => {
            allData = data;
            const select = document.getElementById("currencySelect");
            select.innerHTML = Object.keys(data)
              .map((k) => `<option value="${k}">${k}</option>`)
              .join("");
            updateChart();
          });
      }

      function updateChart() {
        const currency = document.getElementById("currencySelect").value;
        const data = allData[currency] || [];

        const DAY_WINDOW = 2; // ğŸ‘ˆ åªæ”¹è¿™ä¸ªå€¼

        const now = new Date();
        const windowStart = new Date(
          now.getTime() - DAY_WINDOW * 24 * 60 * 60 * 1000
        );
        const filtered = data.filter(
          (d) => new Date(d.datetime) >= windowStart
        );

        const historyOnly = filtered.filter((d) => d.rate !== null);
        const predictionOnly = filtered.filter(
          (d) => d.rate === null && d.predicted !== null
        );

        const combined = [...historyOnly, ...predictionOnly];

        const labels = combined.map((d) => d.datetime);
        const historyRates = combined.map((d) =>
          d.rate !== null ? d.rate : null
        );
        const predictionRates = combined.map((d) =>
          d.rate === null && d.predicted !== null ? d.predicted : null
        );

        const lastHistIndex = historyRates
          .map((v, i) => (v !== null ? i : -1))
          .filter((i) => i !== -1)
          .pop();
        const firstPredIndex = predictionRates.findIndex((v) => v !== null);

        let connectorData = new Array(combined.length).fill(null);
        if (lastHistIndex !== undefined && firstPredIndex !== -1) {
          connectorData[lastHistIndex] = historyRates[lastHistIndex];
          connectorData[firstPredIndex] = predictionRates[firstPredIndex];
        }

        const ctx = document.getElementById("rateChart").getContext("2d");
        if (chartInstance) chartInstance.destroy();

        const visibleStart = labels.length > 10 ? labels.length - 10 : 0;
        const visibleEnd = labels.length - 1;

        chartInstance = new Chart(ctx, {
          type: "line",
          data: {
            labels: labels,
            datasets: [
              {
                label: `${currency} å†å²æ±‡ç‡`,
                data: historyRates,
                borderColor: "rgba(75, 192, 192, 1)",
                backgroundColor: "rgba(75, 192, 192, 0.1)",
                fill: true,
                tension: 0.2,
                spanGaps: false,
              },
              {
                label: `${currency} é¢„æµ‹æ±‡ç‡`,
                data: predictionRates,
                borderColor: "rgba(255, 99, 132, 1)",
                borderDash: [6, 6],
                pointBackgroundColor: "rgba(255, 99, 132, 1)",
                pointStyle: "circle",
                pointRadius: 4,
                fill: false,
                tension: 0,
                spanGaps: false,
              },
              {
                label: "è¿æ¥çº¿",
                data: connectorData,
                borderColor: "rgba(128, 128, 128, 0.5)",
                borderDash: [3, 3],
                pointRadius: 0,
                fill: false,
                tension: 0,
                spanGaps: true,
                showLine: true,
              },
            ],
          },
          options: {
            responsive: true,
            interaction: {
              mode: "index",
              intersect: false,
            },
            plugins: {
              tooltip: {
                callbacks: {
                  title: function (context) {
                    return `æ—¶é—´ï¼š${context[0].label}`;
                  },
                  label: function (context) {
                    return `${context.dataset.label}ï¼š${context.formattedValue}`;
                  },
                },
              },
              legend: {
                labels: {
                  usePointStyle: true,
                  filter: function (legendItem) {
                    return legendItem.text !== "è¿æ¥çº¿";
                  },
                },
              },
              zoom: {
                limits: {
                  x: {
                    min: 0,
                    max: labels.length - 1,
                    minRange: 5, // âœ… æ§åˆ¶æ»šè½®ç¼©æ”¾æœ€å°å®½åº¦
                  },
                },
                zoom: {
                  wheel: { enabled: true },
                  pinch: { enabled: true },
                  mode: "x",
                },
                pan: {
                  enabled: true,
                  mode: "x",
                },
              },
            },
            scales: {
              x: {
                min: visibleStart,
                max: visibleEnd,
                title: { display: true, text: "æ—¶é—´" },
                ticks: { display: false },
              },
              y: {
                title: { display: true, text: "æ±‡ç‡" },
                grace: "5%",
              },
            },
          },
        });
      }

      window.onload = function () {
        loadLatestRates();
        loadChartData();
      };
    </script>
  </body>
</html>
