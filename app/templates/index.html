<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>Janus API æœåŠ¡</title>
    <style>
        body { font-family: sans-serif; padding: 2em; max-width: 960px; margin: auto; }
        h1 { color: #2c3e50; }
        ul { line-height: 1.8em; }
        code { background: #f4f4f4; padding: 0.2em 0.5em; border-radius: 4px; }
        table { border-collapse: collapse; width: 100%; margin-top: 1em; }
        th, td { padding: 8px 12px; border: 1px solid #ccc; text-align: center; }
        select, button { padding: 6px 12px; margin-top: 10px; }
    </style>

    <!-- Chart.js ä¸»åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Chart.js Zoom æ’ä»¶ -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
</head>
<body>
    <h1>ğŸŒ Hiï¼ç§ã®åå‰ã¯Janus!<br>
        ãã†ã‚ˆã€ã‚ã®Jervisã®åƒšè‰¦ã®â€¦â€¦<br>
        ãˆã€çŸ¥ã‚‰ãªã„?å®Œã£å…¨ã«ãƒ¢ã‚°ãƒªã­ã€‚<br>
        ã„ã„?ã—ã£ã‹ã‚Šè¦šãˆã¦ãŠããªã•ã„!</h1>

    <h2>âš“ å¯ç”¨æ¥å£ï¼š</h2>
    <ul>
        <li><code>GET /api/config</code> - æŸ¥çœ‹æˆ–æ›´æ–°ç›‘æ§é…ç½®</li>
        <li><code>POST /api/fetch</code> - æ‰‹åŠ¨æŠ“å–æ±‡ç‡æ•°æ®</li>
        <li><code>GET /api/history</code> - æŸ¥çœ‹å†å²è®°å½•</li>
        <li><code>GET /api/logs/latest</code> - æŸ¥çœ‹æœ€æ–°æ—¥å¿—</li>
    </ul>

    <h2>âš™ï¸ è‡ªåŠ¨åŒ–æ§åˆ¶</h2>
    <p>å½“å‰çŠ¶æ€ï¼š<span id="status">æœªçŸ¥</span></p>
    <button onclick="toggleSwitch()">åˆ‡æ¢è‡ªåŠ¨å¼€å…³</button>

    <h2>ğŸ“Š æœ€æ–°æ±‡ç‡</h2>
    <table id="rateTable">
        <thead>
            <tr>
                <th>æ—¥æœŸ</th>
                <th>è´§å¸</th>
                <th>æ±‡ç‡</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <h2>ğŸ“ˆ æ±‡ç‡èµ°åŠ¿å›¾</h2>
    <select id="currencySelect" onchange="updateChart()"></select>
    <canvas id="rateChart" width="800" height="300" style="max-width: 100%; margin-top: 1em;"></canvas>

    <h2>ğŸ” æŸ¥çœ‹å®Œæ•´å†å²æ•°æ®</h2>
    <a href="/history" target="_blank">
        <button>æŸ¥çœ‹å†å²è®°å½•è¡¨</button>
    </a>

    <script>
        let chartInstance = null;
        let allData = {};

        function toggleSwitch() {
            fetch('/api/switch/toggle', { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    document.getElementById("status").textContent = data.status;
                });
        }

        function loadLatestRates() {
            fetch('/api/latest')
                .then(res => res.json())
                .then(data => {
                    const tbody = document.querySelector("#rateTable tbody");
                    tbody.innerHTML = "";
                    data.forEach(row => {
                        const tr = document.createElement("tr");
                        tr.innerHTML = `<td>${row.Date}</td><td>${row.Currency}</td><td>${row.Rate}</td>`;
                        tbody.appendChild(tr);
                    });
                });
        }

        function loadChartData() {
            fetch('/api/history/chart')
                .then(res => res.json())
                .then(data => {
                    allData = data;
                    const select = document.getElementById("currencySelect");
                    select.innerHTML = Object.keys(data).map(k => `<option value="${k}">${k}</option>`).join("");
                    updateChart();
                });
        }

        function updateChart() {
            const currency = document.getElementById("currencySelect").value;
            const data = allData[currency] || [];

            const labels = data.map(item => item.date);
            const rates = data.map(item => item.rate);

            const ctx = document.getElementById("rateChart").getContext("2d");

            if (chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `${currency} æ±‡ç‡`,
                        data: rates,
                        borderWidth: 2,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        backgroundColor: 'rgba(75, 192, 192, 0.1)',
                        fill: true,
                        tension: 0.2
                    }]
                },
                options: {
                    responsive: true,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        zoom: {
                            zoom: {
                                wheel: { enabled: true },
                                pinch: { enabled: true },
                                mode: 'x',
                            },
                            pan: {
                                enabled: true,
                                mode: 'x',
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'æ—¥æœŸ' }
                        },
                        y: {
                            title: { display: true, text: 'æ±‡ç‡' }
                        }
                    }
                }
            });
        }

        window.onload = function () {
            fetch('/api/switch/status')
                .then(res => res.json())
                .then(data => {
                    document.getElementById("status").textContent = data.status;
                });

            loadLatestRates();
            loadChartData();
        }
    </script>
</body>
</html>
